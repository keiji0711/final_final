{% extends "base.html" %}
{% block title %}Student List{% endblock %}

{% block content %}
<div class="p-6 space-y-8">

  <!-- Page Title + Add Student Button -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold text-white tracking-wide">üë©‚Äçüéì Student List</h2>
    <button id="addStudentBtn"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">
      + Add Student
    </button>
  </div>

  <!-- Search -->
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
    <input type="text" id="searchInput" placeholder="Search students..."
      class="w-full sm:w-1/3 bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:outline-none focus:ring focus:ring-blue-500">
  </div>

  <!-- Student Table -->
  <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-lg p-6 overflow-x-auto">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-800 text-gray-300 text-left text-sm uppercase tracking-wider">
          <th class="px-4 py-3">USN</th>
          <th class="px-4 py-3">Name</th>
          <th class="px-4 py-3">Department</th>
          <th class="px-4 py-3">Contact</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody id="studentTableBody"></tbody>
    </table>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4 text-gray-300">
      <button id="prevBtn" class="px-3 py-1 bg-gray-700 rounded disabled:opacity-50">Prev</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn" class="px-3 py-1 bg-gray-700 rounded disabled:opacity-50">Next</button>
    </div>
  </div>
</div>

<!-- Add / Update Student Modal -->
<div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-gray-900 rounded-xl p-6 w-96 shadow-lg">
    <h3 id="modalTitle" class="text-2xl font-semibold text-white mb-4">Add Student</h3>
    <form id="studentForm" class="flex flex-col gap-3">
      <input type="text" id="usnInput" name="usn" placeholder="USN"
             class="px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none" required>
      <input type="text" id="nameInput" name="name" placeholder="Name"
             class="px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none" required>
      
      <!-- Course as Select Dropdown -->
      <select id="courseInput" name="course"
              class="px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none" required>
        <option value="">-- Select Department --</option>
        <option value="CED">CED</option>
        <option value="BED">BED</option>
      </select>

      <input type="text" id="contactInput" name="contact" placeholder="Contact"
             class="px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none" required>
      <div class="flex justify-end gap-2 mt-2">
        <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-white">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-white">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Centered Flash Notification -->
<div id="flash-container" class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none"></div>

<script>
const students = {{ students|tojson }};
let filteredStudents = [...students];
let currentPage = 1;
const rowsPerPage = 9;

const modal = document.getElementById("studentModal");
const modalTitle = document.getElementById("modalTitle");
const studentForm = document.getElementById("studentForm");
let editingUSN = null;

// ----------------- Flash Message -----------------
function showFlash(message, category="success") {
    const flashContainer = document.getElementById("flash-container");
    flashContainer.innerHTML = "";

    const flashDiv = document.createElement("div");
    flashDiv.className = `relative px-6 py-4 rounded-lg shadow-lg w-80 h-28 flex flex-col items-center justify-center pointer-events-auto text-center animate-fade-in
        ${category === "success" ? "bg-white text-black" : "bg-red-500 text-white"}`;
    flashDiv.innerHTML = `
        <span class="text-lg font-semibold">${message}</span>
        <button class="absolute top-2 right-2 text-xl font-bold hover:text-gray-500">&times;</button>
    `;

    flashDiv.querySelector("button").addEventListener("click", () => flashDiv.remove());
    flashContainer.appendChild(flashDiv);

    setTimeout(() => {
        flashDiv.classList.add("opacity-0");
        flashDiv.addEventListener("transitionend", () => flashDiv.remove());
    }, 3000);
}

// ----------------- Render Table -----------------
function renderTable() {
  const tbody = document.getElementById("studentTableBody");
  tbody.innerHTML = "";
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginated = filteredStudents.slice(start, end);

  paginated.forEach(student => {
    const row = document.createElement("tr");
    row.className = "border-b border-gray-700 hover:bg-gray-800 transition cursor-pointer";
    row.innerHTML = `
      <td class="px-4 py-3 text-gray-300">${student.usn}</td>
      <td class="px-4 py-3 text-white">${student.name}</td>
      <td class="px-4 py-3 text-gray-300">${student.course}</td>
      <td class="px-4 py-3 text-gray-400">${student.contact}</td>
      <td class="px-4 py-3 space-x-2">
        <button class="editBtn bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded">Edit</button>
        <button class="deleteBtn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Delete</button>
      </td>
    `;

    // Whole row clickable ‚Üí goes to profile
    row.addEventListener("click", () => {
      window.location.href = `/stud_profiling?usn=${student.usn}`;
    });

    // Prevent row navigation when clicking buttons
    row.querySelector(".editBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      openModal("edit", student);
    });
    row.querySelector(".deleteBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      deleteStudent(student.usn);
    });

    tbody.appendChild(row);
  });

  document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${Math.max(1, Math.ceil(filteredStudents.length / rowsPerPage))}`;
  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = end >= filteredStudents.length;
}

// ----------------- Pagination -----------------
document.getElementById("prevBtn").addEventListener("click", () => { if(currentPage>1){currentPage--;renderTable();} });
document.getElementById("nextBtn").addEventListener("click", () => { if(currentPage*rowsPerPage<filteredStudents.length){currentPage++;renderTable();} });

// ----------------- Search -----------------
document.getElementById("searchInput").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  filteredStudents = students.filter(s =>
    s.name.toLowerCase().includes(query) ||
    s.course.toLowerCase().includes(query) ||
    s.usn.toString().includes(query) ||
    s.contact.toLowerCase().includes(query)
  );
  currentPage = 1;
  renderTable();
});

// ----------------- Modal -----------------
document.getElementById("addStudentBtn").addEventListener("click", () => openModal("add"));
document.getElementById("cancelBtn").addEventListener("click", () => modal.classList.add("hidden"));

function openModal(mode, student=null) {
  modal.classList.remove("hidden");
  if(mode==="add") {
    modalTitle.textContent = "Add Student";
    editingUSN = null;
    studentForm.reset();
    document.getElementById("usnInput").disabled = false;
  } else if(mode==="edit") {
    modalTitle.textContent = "Edit Student";
    editingUSN = student.usn;
    document.getElementById("usnInput").value = student.usn;
    document.getElementById("usnInput").disabled = true;
    document.getElementById("nameInput").value = student.name;
    document.getElementById("courseInput").value = student.course;
    document.getElementById("contactInput").value = student.contact;
  }
}

// ----------------- Form Submit -----------------
studentForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    usn: document.getElementById("usnInput").value,
    name: document.getElementById("nameInput").value,
    course: document.getElementById("courseInput").value,
    contact: document.getElementById("contactInput").value
  };

  const url = editingUSN ? `/update_student/${editingUSN}` : "/add_student";
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();

  showFlash(data.message, data.success ? "success" : "error");

  if(data.success){
    if(editingUSN){
      const idx = students.findIndex(s => s.usn === editingUSN);
      students[idx] = payload;
    } else {
      students.push(payload);
    }
    filteredStudents = [...students];
    renderTable();
    modal.classList.add("hidden");
  }
});

// ----------------- Delete -----------------
async function deleteStudent(usn){
  if(!confirm("Are you sure you want to delete this student?")) return;
  const res = await fetch(`/delete_student/${usn}`, {method:"POST"});
  const data = await res.json();

  showFlash(data.message, data.success ? "success" : "error");

  if(data.success){
    const idx = students.findIndex(s => s.usn === usn);
    students.splice(idx,1);
    filteredStudents = [...students];
    renderTable();
  }
}

renderTable();
</script>

<style>
@keyframes fadeIn {
    0% { opacity: 0; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1); }
}
.animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
}
</style>
{% endblock %}

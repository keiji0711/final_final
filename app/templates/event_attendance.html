{% extends "base.html" %}
{% block title %}Event Attendance{% endblock %}

{% block content %}
<div class="p-6 flex flex-col gap-6 h-screen">

  <!-- Event Header + Live Clock + Export Button -->
  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
   <div>
  <h2 class="text-3xl font-bold text-white tracking-wide">üìÖ {{ event.event_name }} - Attendance</h2>
  <p class="text-gray-300 mt-1">Date: {{ event.event_date }} | Semester: {{ event.semester }}</p>
  {% if event.cutoff_time %}
    {% set hour = event.cutoff_time.split(':')[0] | int %}
    {% set minute = event.cutoff_time.split(':')[1] %}
    {% if hour > 12 %}
      {% set hour = hour - 12 %}
    {% elif hour == 0 %}
      {% set hour = 12 %}
    {% endif %}
    <p class="text-gray-400 mt-1">
      ‚è± Attendance Cutoff Time: {{ "%02d"|format(hour) }}:{{ minute }}
    </p>
  {% endif %}
</div>

    <div class="flex gap-4 items-center">
      <div id="liveClockContainer"
           class="text-white font-mono text-2xl px-4 py-2 rounded-lg border border-gray-500 bg-gray-800 shadow-lg">
        ‚è∞ <span id="liveClock">--:--:--</span>
      </div>
      <!-- Export Button -->
     <a href="{{ url_for('event.export_excel', event_id=event.id) }}"
   class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">
   Export to Excel
</a>

    </div>
  </div>

  <div class="flex flex-col lg:flex-row gap-6 flex-1 overflow-hidden">

    <!-- Student Attendance Table (LEFT) -->
    <div class="lg:flex-[0.7] bg-gray-900 border border-gray-700 rounded-xl shadow-lg p-6 flex flex-col overflow-hidden">
      <h3 class="text-2xl font-semibold text-gray-100 mb-4">üìù Student Attendance</h3>
      <div class="flex-1 overflow-y-auto max-h-[75vh]">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-gray-800 text-gray-300 uppercase tracking-wider sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left">USN</th>
              <th class="px-6 py-3 text-left">Name</th>
              <th class="px-6 py-3 text-left">Date</th>
              <th class="px-6 py-3 text-left">Time In</th>
              <th class="px-6 py-3 text-left">Time Out</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
            {% if attendance %}
            {% for record in attendance %}
            <tr class="border-b border-gray-700 hover:bg-gray-800 transition {% if record.time_in == 'Late' %}bg-orange-600 bg-opacity-20{% endif %}" data-usn="{{ record.usn }}">
              <td class="px-6 py-3 text-gray-300">{{ record.usn }}</td>
              <td class="px-6 py-3 text-white">{{ record.name }}</td>
              <td class="px-6 py-3 text-gray-300">{{ record.date }}</td>
              <td class="px-6 py-3 text-gray-300">{{ record.time_in or "-" }}</td>
              <td class="px-6 py-3 text-gray-300">{{ record.time_out or "-" }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="5" class="text-center text-gray-400 py-4">No attendance records yet.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Barcode Scan Area (RIGHT) -->
    <div class="lg:flex-[0.3] bg-gray-900 border border-gray-700 rounded-xl shadow-lg p-6 flex flex-col gap-4 max-h-[40vh]">
      <h3 class="text-2xl font-semibold text-gray-100 mb-2">üîç Scan Barcode</h3>
      <span id="modeIndicator"
            class="px-4 py-2 rounded-lg text-white font-bold bg-green-600 shadow mb-2">
        Mode: Time In
      </span>
      <form id="attendanceForm" class="flex flex-col gap-2">
        <input type="text" id="barcodeInput" name="barcode"
               placeholder="Scan or type barcode here..."
               class="flex-1 px-4 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
               autofocus required>
        <button type="button" id="toggleModeBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
          Switch to Time Out
        </button>
      </form>
      <p id="statusMessage" class="text-sm mt-2"></p>
    </div>

  </div>
</div>

<!-- üîä Beep sound -->
<audio id="beepSound" src="{{ url_for('static', filename='time_in.mp3') }}" preload="auto"></audio>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// ===== Live Clock =====
function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").textContent = now.toLocaleTimeString('en-US', { hour12: true });
}
setInterval(updateClock, 1000);
updateClock();

// ===== Mode Handling =====
let isTimeIn = true;
function updateModeUI() {
  const indicator = document.getElementById("modeIndicator");
  const toggleBtn = document.getElementById("toggleModeBtn");
  if (isTimeIn) {
    indicator.textContent = "Mode: Time In";
    indicator.className = "px-4 py-2 rounded-lg text-white font-bold bg-green-600 shadow mb-2";
    toggleBtn.textContent = "Switch to Time Out";
  } else {
    indicator.textContent = "Mode: Time Out";
    indicator.className = "px-4 py-2 rounded-lg text-white font-bold bg-red-600 shadow mb-2";
    toggleBtn.textContent = "Switch to Time In";
  }
}
document.getElementById("toggleModeBtn").addEventListener("click", () => {
  isTimeIn = !isTimeIn;
  updateModeUI();
});

// ===== Socket.IO Setup =====
const socket = io();
const eventId = {{ event.id }};
const cutoffTime = "{{ event.cutoff_time or '' }}";

// ===== Utility: Check Cutoff =====
function isAfterCutoff() {
  if (!cutoffTime) return false;
  const now = new Date();
  const [hours, minutes] = cutoffTime.split(":").map(Number);
  const cutoff = new Date(now);
  cutoff.setHours(hours, minutes, 0, 0);
  return now > cutoff;
}

// ===== Attendance Logic =====
async function sendAttendance(barcode) {
  const msgEl = document.getElementById("statusMessage");
  const afterCutoff = isAfterCutoff();

  if (isTimeIn && afterCutoff) {
    msgEl.textContent = "‚ö† Attendance cutoff time reached. Cannot Time In.";
    msgEl.className = "text-yellow-400";
    return;
  }

  const action = isTimeIn ? "time_in" : "time_out";

  try {
    const res = await fetch("/scan_attendance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ barcode, action, event_id: eventId }),
    });

    const data = await res.json();

    if (res.ok) {
      msgEl.textContent = `${barcode} ${isTimeIn ? "timed IN" : "timed OUT"} successfully.`;
      msgEl.className = isTimeIn ? "text-green-400" : "text-red-400";
      updateAttendanceRow(data.record);

      // üîä Play beep sound on success
      document.getElementById("beepSound").play();
    } else {
      msgEl.textContent = data.error || "Error recording attendance.";
      msgEl.className = "text-red-400";
    }
  } catch (err) {
    console.error(err);
    msgEl.textContent = "Connection error.";
    msgEl.className = "text-red-400";
  }
}

// ===== Update/Add Table Row =====
function updateAttendanceRow(data) {
  const tbody = document.getElementById("attendanceTableBody");
  let row = tbody.querySelector(`tr[data-usn="${data.usn}"]`);

  if (!row) {
    row = document.createElement("tr");
    row.className = "border-b border-gray-700 hover:bg-gray-800 transition";
    row.dataset.usn = data.usn;
    tbody.prepend(row);
  }

  const lateClass = (data.time_in === 'Late') ? 'bg-orange-600 bg-opacity-20' : '';

  row.innerHTML = `
    <td class="px-6 py-3 text-gray-300">${data.usn}</td>
    <td class="px-6 py-3 text-white">${data.name}</td>
    <td class="px-6 py-3 text-gray-300">${data.date}</td>
    <td class="px-6 py-3 text-gray-300 ${lateClass}">${data.time_in || "-"}</td>
    <td class="px-6 py-3 text-gray-300">${data.time_out || "-"}</td>
  `;
}

// ===== Socket.IO real-time updates =====
socket.on("attendance_update", (data) => {
  if (data.event_id !== eventId) return;
  updateAttendanceRow(data);

  // üîä Play beep sound for real-time updates too
  document.getElementById("beepSound").play();
});

// ===== Form submit =====
document.getElementById("attendanceForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const barcode = document.getElementById("barcodeInput").value.trim();
  if (barcode) {
    sendAttendance(barcode);
    document.getElementById("barcodeInput").value = "";
  }
});

// Initialize mode UI
updateModeUI();
</script>
{% endblock %}
